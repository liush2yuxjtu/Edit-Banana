<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DrawIO é¢„è§ˆ - Edit-Banana</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #1e1e1e;
            height: 100vh;
            overflow: hidden;
        }
        .header {
            background: #2d2d2d;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #444;
        }
        .header h1 {
            color: #fff;
            font-size: 16px;
            font-weight: 500;
        }
        .header .actions {
            display: flex;
            gap: 10px;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn-primary {
            background: #4CAF50;
            color: white;
        }
        .btn-primary:hover {
            background: #45a049;
        }
        .btn-secondary {
            background: #555;
            color: white;
        }
        .btn-secondary:hover {
            background: #666;
        }
        .container {
            height: calc(100vh - 60px);
            position: relative;
        }
        #drawio-frame {
            width: 100%;
            height: 100%;
            border: none;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            text-align: center;
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #444;
            border-top-color: #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff6b6b;
            text-align: center;
            padding: 20px;
        }
        .error h2 {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸŒ DrawIO ç¼–è¾‘å™¨ - {{ task_id }}</h1>
        <div class="actions">
            <a href="/api/v1/download/{{ task_id }}.drawio" class="btn btn-secondary" download>
                â¬‡ï¸ ä¸‹è½½
            </a>
            <button class="btn btn-primary" onclick="exportImage()">
                ğŸ–¼ï¸ å¯¼å‡ºå›¾ç‰‡
            </button>
        </div>
    </div>
    <div class="container">
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p>æ­£åœ¨åŠ è½½ DrawIO ç¼–è¾‘å™¨...</p>
        </div>
        <iframe id="drawio-frame" style="display: none;"></iframe>
    </div>

    <script>
        // DrawIO XML æ•°æ® (Base64 ç¼–ç )
        const drawioXml = `{{ xml_content }}`;
        const iframe = document.getElementById('drawio-frame');
        const loading = document.getElementById('loading');

        // æ„å»º DrawIO Embed URL
        const embedUrl = `https://embed.diagrams.net/?embed=1&proto=json&configure=1&xml=${encodeURIComponent(drawioXml)}`;
        
        iframe.src = embedUrl;
        
        // ç›‘å¬ iframe åŠ è½½å®Œæˆ
        iframe.onload = function() {
            loading.style.display = 'none';
            iframe.style.display = 'block';
        };

        // ä¸ DrawIO é€šä¿¡
        window.addEventListener('message', function(event) {
            if (event.origin !== 'https://embed.diagrams.net') return;
            
            const msg = JSON.parse(event.data);
            console.log('DrawIO Event:', msg);
            
            switch(msg.event) {
                case 'init':
                    // ç¼–è¾‘å™¨åˆå§‹åŒ–å®Œæˆ
                    loading.style.display = 'none';
                    iframe.style.display = 'block';
                    break;
                case 'save':
                    // ä¿å­˜äº‹ä»¶
                    console.log('Saving...', msg.xml);
                    // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è‡ªåŠ¨ä¿å­˜é€»è¾‘
                    break;
                case 'export':
                    // å¯¼å‡ºäº‹ä»¶
                    console.log('Export:', msg.data);
                    break;
            }
        });

        // å¯¼å‡ºå›¾ç‰‡åŠŸèƒ½
        function exportImage() {
            const message = JSON.stringify({
                action: 'export',
                format: 'png',
                border: 10,
                crop: false
            });
            iframe.contentWindow.postMessage(message, 'https://embed.diagrams.net');
        }

        // å¤„ç†åŠ è½½é”™è¯¯
        iframe.onerror = function() {
            loading.innerHTML = `
                <div class="error">
                    <h2>âš ï¸ åŠ è½½å¤±è´¥</h2>
                    <p>æ— æ³•åŠ è½½ DrawIO ç¼–è¾‘å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</p>
                </div>
            `;
        };
    </script>
</body>
</html>
